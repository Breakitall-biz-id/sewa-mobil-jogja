---
import "../styles/global.css";
import { getSiteSettings, urlFor } from "../lib/sanity";
import WhatsAppButton from "../components/WhatsAppButton.astro";

interface Props {
  title: string;
  description: string;
  image?: string;
  type?: "website" | "article";
  publishedTime?: string;
  noindex?: boolean;
  canonicalUrl?: string;
  lang?: "id" | "en";
}

const {
  title,
  description,
  image,
  type = "website",
  publishedTime,
  noindex = false,
  canonicalUrl,
  lang = "id",
} = Astro.props;

// Fetch site settings from Sanity
const settings = await getSiteSettings();

const siteUrl = "https://sewamobiljogjaku.id";
const siteName = settings?.siteName || "SMJ Trans Jogja";
const fullTitle = `${title} - ${siteName}`;
const defaultOgImage = settings?.defaultSeo?.ogImage
  ? urlFor(settings.defaultSeo.ogImage).width(1200).height(630).url()
  : "/og-image.png";
const ogImage = image || defaultOgImage;
const fullImageUrl = ogImage.startsWith("http")
  ? ogImage
  : `${siteUrl}${ogImage}`;
const canonical = canonicalUrl || Astro.url.href;

// Alternate language URLs
const currentPath = Astro.url.pathname;
const idUrl =
  lang === "id" ? canonical : `${siteUrl}${currentPath.replace("/en/", "/")}`;
const enUrl = lang === "en" ? canonical : `${siteUrl}/en${currentPath}`;

// Dynamic logo URL
const logoUrl = settings?.logo
  ? urlFor(settings.logo).width(400).url()
  : `${siteUrl}/images/logo.webp`;

// Build social links array
const socialLinks = [
  settings?.socialMedia?.instagram,
  settings?.socialMedia?.youtube,
  settings?.socialMedia?.tiktok,
  settings?.socialMedia?.facebook,
].filter(Boolean);

// Schema.org LocalBusiness
const localBusinessSchema = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  "@id": `${siteUrl}/#organization`,
  name: siteName,
  alternateName: "Sewa Mobil Jogja",
  description:
    settings?.tagline ||
    "Penyedia jasa sewa mobil terpercaya di Yogyakarta sejak 2015. Melayani sewa lepas kunci maupun dengan supir.",
  url: siteUrl,
  logo: logoUrl,
  image: fullImageUrl,
  telephone: settings?.phone || "+62-881-2725-610",
  email: settings?.email || "info@sewamobiljogjaku.id",
  address: {
    "@type": "PostalAddress",
    streetAddress: "Jl. Kaliurang Km 12",
    addressLocality: "Ngaglik, Sleman",
    addressRegion: "DIY",
    postalCode: "55581",
    addressCountry: "ID",
  },
  geo: {
    "@type": "GeoCoordinates",
    latitude: -7.7956,
    longitude: 110.3695,
  },
  openingHoursSpecification: {
    "@type": "OpeningHoursSpecification",
    dayOfWeek: [
      "Monday",
      "Tuesday",
      "Wednesday",
      "Thursday",
      "Friday",
      "Saturday",
      "Sunday",
    ],
    opens: "00:00",
    closes: "23:59",
  },
  priceRange: "Rp 300.000 - Rp 1.500.000",
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "4.9",
    reviewCount: "200",
    bestRating: "5",
  },
  sameAs:
    socialLinks.length > 0
      ? socialLinks
      : [
          "https://www.instagram.com/sewamobiljogjaku/",
          "https://www.youtube.com/@sewamobiljogjaku",
          "https://www.tiktok.com/@sewamobiljogjaku",
        ],
};
---

<!doctype html>
<html class="light" lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <!-- Primary Meta Tags -->
    <title>{fullTitle}</title>
    <meta name="title" content={fullTitle} />
    <meta name="description" content={description} />
    {noindex && <meta name="robots" content="noindex, nofollow" />}

    <!-- Canonical & Hreflang -->
    <link rel="canonical" href={canonical} />
    <link rel="alternate" hreflang="id" href={idUrl} />
    <link rel="alternate" hreflang="en" href={enUrl} />
    <link rel="alternate" hreflang="x-default" href={idUrl} />

    <!-- Open Graph -->
    <meta property="og:type" content={type} />
    <meta property="og:url" content={canonical} />
    <meta property="og:title" content={fullTitle} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={fullImageUrl} />
    <meta property="og:locale" content={lang === "id" ? "id_ID" : "en_US"} />
    <meta property="og:site_name" content={siteName} />

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={fullTitle} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={fullImageUrl} />

    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <!-- Preconnect to Image CDN -->
    <link rel="preconnect" href="https://cdn.sanity.io" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Material Symbols -->
    <link
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap"
      rel="stylesheet"
    />

    <!-- Schema.org -->
    <script
      type="application/ld+json"
      set:html={JSON.stringify(localBusinessSchema)}
    />

    <!-- Theme Color -->
    <meta name="theme-color" content="#1f3b61" />
  </head>
  <body class="bg-[#f6f7f8] text-slate-900 antialiased">
    <slot />

    <WhatsAppButton />

    <script>
      // Optimized: Only load Visual Editing when inside Sanity Studio (iframe)
      // This prevents the 600KB+ bundle from slowing down the live site
      if (
        window.self !== window.top ||
        window.location.search.includes("sanity-preview")
      ) {
        import("@sanity/visual-editing").then(({ enableVisualEditing }) => {
          enableVisualEditing();
          console.log("Visual Editing Enabled");
        });
      }
    </script>
  </body>
</html>
