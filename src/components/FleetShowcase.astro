---
/**
 * Fleet Showcase Section
 * Displays car cards with category filters - Connected to Sanity CMS
 */
import { getAllCars, urlFor } from '../lib/sanity';
import { Image } from "astro:assets";

interface SanityCar {
  _id: string;
  slug?: { current: string };
  name: string;
  category?: string;
  capacity?: number;
  pricePerDay?: number;
  image?: { asset: { _ref: string } };
}

interface Props {
  lang?: 'id' | 'en';
}

const { lang = 'id' } = Astro.props;

const t = lang === 'id' ? {
  title: 'Pilihan Armada Kami',
  subtitle: 'Temukan mobil yang sesuai dengan kebutuhan perjalanan Anda.',
  viewAll: 'Lihat Semua Armada',
  booking: 'Booking',
  startFrom: 'Mulai dari',
  perDay: '/hari',
} : {
  title: 'Our Fleet Selection',
  subtitle: 'Find the perfect car that suits your travel needs.',
  viewAll: 'View All Fleet',
  booking: 'Book Now',
  startFrom: 'Starting from',
  perDay: '/day',
};

const categories = [
  { id: 'all', label: 'All' },
  { id: 'mpv', label: 'MPV' },
  { id: 'city-car', label: 'City Car' },
  { id: 'luxury', label: 'Luxury' },
];

// Fetch cars from Sanity CMS (limit to 3 for homepage showcase)
const sanityCars = await getAllCars() as SanityCar[];
const cars = sanityCars.slice(0, 3).map((car) => ({
  id: car.slug?.current || car._id,
  name: car.name,
  category: car.category || 'mpv',
  specs: `${car.category === 'city-car' ? 'City Car' : car.category === 'mpv' ? 'MPV' : 'Premium'} â€¢ ${car.capacity || 5} Kursi`,
  transmission: 'Automatic',
  price: car.pricePerDay || 0,
  image: car.image ? urlFor(car.image).width(600).height(375).url() : '',
}));

const formatPrice = (price: number) => {
  return new Intl.NumberFormat('id-ID').format(price);
};
---

<section class="section-padding bg-white">
  <div class="container-main">
    <!-- Section Header -->
    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4">
      <div>
        <h2 class="text-3xl sm:text-4xl font-bold text-slate-900 mb-2">{t.title}</h2>
        <p class="text-slate-500">{t.subtitle}</p>
      </div>
      
      <!-- Category Filters -->
      <div class="flex gap-2 bg-slate-100 p-1 rounded-lg" role="tablist">
        {categories.map((cat, index) => (
          <button 
            class={`px-4 py-2 text-sm font-medium rounded-md transition-colors ${
              index === 0 
                ? 'bg-white text-[#1f3b61] shadow-sm' 
                : 'text-slate-500 hover:text-[#1f3b61]'
            }`}
            role="tab"
            data-category={cat.id}
          >
            {cat.label}
          </button>
        ))}
      </div>
    </div>
    
    <!-- Car Cards Grid -->
    <div class="flex overflow-x-auto scrollbar-hide gap-4 pb-4 snap-x snap-mandatory md:grid md:grid-cols-2 lg:grid-cols-3 md:gap-8 md:pb-0 md:overflow-visible">
      {cars.map((car) => (
        <article 
          class="min-w-[85%] sm:min-w-[300px] snap-center bg-background-light dark:bg-[#1f2937] rounded-xl overflow-hidden group border border-slate-100 dark:border-slate-700 md:min-w-0"
          data-category={car.category}
        >
          <!-- Car Image -->
          <div class="aspect-[16/10] bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 relative flex items-center justify-center p-4">
            <Image 
              src={car.image}
              alt={car.name}
              width={600}
              height={375}
              class="w-full h-full object-cover rounded-lg group-hover:scale-105 transition-transform duration-500"
            />
            <div class="absolute top-3 right-3 bg-white/90 dark:bg-black/60 backdrop-blur text-[10px] font-bold px-2 py-0.5 rounded-full text-slate-900 dark:text-white">
              {car.transmission}
            </div>
          </div>
          
          <!-- Car Info -->
          <div class="p-4">
            <h3 class="text-lg font-bold text-slate-900 dark:text-white mb-1">{car.name}</h3>
            <p class="text-xs text-slate-500 dark:text-slate-400 mb-3">{car.specs}</p>
            
            <div class="flex items-end justify-between">
              <div>
                <p class="text-[10px] text-slate-500 dark:text-slate-400">{t.startFrom}</p>
                <p class="text-base font-bold text-primary dark:text-secondary">
                  Rp {formatPrice(car.price)}
                  <span class="text-[10px] font-normal text-slate-500 dark:text-slate-400">{t.perDay}</span>
                </p>
              </div>
              <a 
                href={`/booking?car=${car.id}`}
                class="bg-primary text-white px-3 py-1.5 rounded-md text-xs font-semibold hover:bg-primary/90 transition-colors"
              >
                {t.booking}
              </a>
            </div>
          </div>
        </article>
      ))}
    </div>
    
    <!-- View All Button -->
    <div class="mt-12 text-center">
      <a 
        href="/armada"
        class="inline-flex items-center gap-2 border-2 border-[#1f3b61] text-[#1f3b61] hover:bg-[#1f3b61] hover:text-white px-8 py-3 rounded-lg text-sm font-bold transition-all"
      >
        {t.viewAll}
        <span class="material-symbols-outlined text-[20px]">arrow_forward</span>
      </a>
    </div>
  </div>
</section>
